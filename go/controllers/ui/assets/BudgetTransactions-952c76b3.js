import{av as a,aw as B,ax as g,ay as O,az as D,aA as U,aB as p,S as v,ao as s,aC as T,Z,m as o,A as P,c as r,ap as Q,I as w,aD as z,aE as R,ah as A,ai as I,aF as ee,aG as G,aH as te,aI as ae,T as l,aJ as _,aK as H,aL as $,aM as W,aN as L,D as S,aO as V,aP as ne,v as re,aQ as oe,au as ue,aR as j,aS as E,aT as ce,aU as ie,aV as de,aW as se,aX as le,a as ge,aY as X,s as me,a8 as Y,aZ as k,a_ as pe,O as fe,a$ as be,b0 as ye,B as De,b1 as Ae,a0 as Ie,b2 as q}from"./index-09c2e996.js";import{C as he,F as Ce}from"./FormImportCSV-767bd78d.js";import{G as Te}from"./GetHelp-610c77dd.js";async function Se(e,i,d){const c=await he.import(e);return c!==null?c.data.map(m=>{const u={...a.new(),accounts:[{...a.newAccount(),budgetAccountID:i,status:1}],id:B.new()};if(d.Payee!==""){if(u.budgetPayeeName=m[d.Payee],u.budgetPayeeID=g.findName(u.budgetPayeeName).id,u.budgetPayeeID===null){for(const f of g.data())if(u.budgetPayeeName.toLowerCase().includes(f.name.toLowerCase())){u.budgetPayeeID=f.id;break}}if(u.budgetPayeeID!==null){u.budgetPayeeName="";const f=g.findID(u.budgetPayeeID).budgetCategoryID;f!==null&&(u.categories=[{...a.newCategory(),budgetCategoryID:f}])}}return d.Amount!==""&&(u.amount=O.toNumber(m[d.Amount]),u.accounts[0].amount=u.amount,u.categories!==null&&u.categories.length===1&&(u.categories[0].amount=u.amount)),d.Date!==""&&(u.date=D.fromString(m[d.Date]).toJSON(),u.categories!==null&&u.categories.length===1&&(u.categories[0].yearMonth=D.fromString(`${u.date}`).toYearMonth().toNumber())),u}):[]}function K(e,i){const d=parseInt(e.TRNAMT[0].replace(/\./,""),10),c={...a.new(),accounts:[{...a.newAccount(),amount:d,budgetAccountID:i,status:1}],amount:d,date:e.DTPOSTED[0].replace(/(\d{4})(\d{2})(\d{2}).*/,"$1-$2-$3"),id:B.new()};if(e.NAME!==void 0&&(c.budgetPayeeName=e.NAME[0]),c.budgetPayeeID=g.findName(c.budgetPayeeName).id,c.budgetPayeeID===null){for(const m of g.data())if(c.budgetPayeeName.toLowerCase().includes(m.name.toLowerCase())){c.budgetPayeeID=m.id;break}}if(c.budgetPayeeID!==null){c.budgetPayeeName="";const m=g.findID(c.budgetPayeeID).budgetCategoryID;m!==null&&(c.categories=[{...a.newCategory(),amount:d,budgetCategoryID:m,yearMonth:D.fromString(c.date).toYearMonth().toNumber()}])}return c}async function Pe(e,i){const d=await U(()=>import("./xml2js-b4bfce7a.js").then(N=>N.x),["assets/xml2js-b4bfce7a.js","assets/index-09c2e996.js","assets/index-5446acb6.css"]),c=[],f=`<OFX> ${e.split("<OFX>",2)[1].replace(/>\s+</g,"><").replace(/\s+</g,"<").replace(/>\s+/g,">").replace(/<([A-Z0-9_]*)+\.+([A-Z0-9_]*)>([^<]+)/g,"<$1$2>$3").replace(/<(\w+?)>([^<]+)/g,"<$1>$2</$1>")}`;return d.parseString(f,(N,b)=>{if(b.OFX.BANKMSGSRSV1!==void 0)for(const h of b.OFX.BANKMSGSRSV1[0].STMTTRNRS[0].STMTRS[0].BANKTRANLIST[0].STMTTRN)c.push(K(h,i));else if(b.OFX.CREDITCARDMSGSRSV1!==void 0)for(const h of b.OFX.CREDITCARDMSGSRSV1[0].CCSTMTTRNRS[0].CCSTMTRS[0].BANKTRANLIST[0].STMTTRN)c.push(K(h,i))}),c}function J(e){if(e.template.date!==null){const i=D.fromString(e.template.date).toYearMonth(),d=k.nextTimestamp(e.recurrence,Z.fromCivilDate(D.fromString(e.template.date))).toCivilDate().toYearMonth();if(i!==d&&e.template.categories!==null)for(let c=0;c<e.template.categories.length;c++)e.template.categories[c].yearMonth=d.toNumber()}}function ve(){return{view:e=>o("div.TableData__buttons",[o("span",P.formatCivilDate(e.attrs.template.date)),o("div",[o(X,{id:`add-${e.attrs.id}`,name:r.translate(me),onclick:async()=>{const i=Y(e.attrs);return a.create(i.template).then(async()=>(i.template.date!==null&&(i.template.date=k.nextCivilDate(i.recurrence,D.fromString(i.template.date)).toJSON()),J(i),p.update(i,!0))).then(async()=>a.read())},permitted:A.permitted(I.Budget,!0),primary:!0,requireOnline:!0}),o(X,{accent:!0,id:`skip-${e.attrs.id}`,name:r.translate(pe),onclick:async()=>{const i=Y(e.attrs);return i.template.date=k.nextCivilDate(i.recurrence,D.fromString(`${i.template.date}`)).toJSON(),J(i),p.update(i).then(async()=>a.read())},permitted:A.permitted(I.Budget,!0),requireOnline:!0})])])}}function Oe(){const e={addRecurrence:p.new(),budgetAccount:v(s.new()),budgetCategory:T.new(),budgetCategoryMonth:0,budgetPayee:g.new(),cleared:a.new(),columns:v({}),formImportFields:{Amount:"",Date:"",Payee:""},formImportVisible:!1,formRecurrence:{data:p.new(),visible:!1},formTransaction:{data:a.new(),visible:!1},formTransactionRecurring:!1,importID:v(null),page:1,recurrenceCount:0,recurring:!1,yearMonth:Z.now().toCivilDate().toYearMonth()},i=v.lift((t,n)=>(o.redraw(),p.findBudgetAccountID(t,n.id)),p.data,e.budgetAccount);function d(t){if(e.budgetAccount().id!==null&&t.accounts!==null){for(const n of t.accounts)if(n.budgetAccountID===e.budgetAccount().id)return n.amount}if(e.budgetCategory.id!==null&&t.categories!==null){for(const n of t.categories)if(n.budgetCategoryID===e.budgetCategory.id)return n.amount}return t.amount}function c(){const t="/budget/transactions?";if(e.budgetAccount().id!==null)return`${t}account=${e.budgetAccount().id}`;if(e.budgetCategory.id!==null){let n=`${t}category=${e.budgetCategory.id}`;return e.budgetCategoryMonth!==null&&(n+=`&month=${e.budgetCategoryMonth}`),n}return e.budgetPayee.id!==null?`${t}payee=${e.budgetPayee.id}`:""}function m(){return e.budgetAccount().id!==null?s.findID(e.budgetAccount().id).name:e.budgetCategory.id!==null?T.findID(e.budgetCategory.id).name:e.budgetPayee.id!==null?g.findID(e.budgetPayee.id).name:""}function u(){return e.budgetAccount().id!==null?r.translate(fe):e.budgetCategory.id!==null?r.translate(be):e.budgetPayee.id!==null?r.translate(ye):""}function f(){if(!(a.data.length===0||a.data.length===a.total))return`${e.page===1?"1":50*(e.page-1)+1} - ${50*(e.page-1)+a.data().length} ${r.translate(De)} ${a.total} ${r.translate(Ae)}`}function N(){const t=a.new();return t.date=a.lastDate,e.budgetAccount().id!==null&&(t.accounts=[{...a.newAccount(),budgetAccountID:e.budgetAccount().id,id:B.new()}]),e.budgetCategory.id!==null&&(t.categories=[{...a.newCategory(),budgetCategoryID:e.budgetCategory.id,id:B.new()}],e.budgetCategoryMonth!==null&&t.date!==null&&(t.categories[0].yearMonth=D.fromString(t.date).toYearMonth().toNumber())),e.budgetPayee.id!==null&&(t.budgetPayeeID=e.budgetPayee.id),t}const b=()=>{e.columns({date:"",nextDate:"",payee:"",category:"",note:"",amount:"",balance:""}),o.route.param().account!==void 0&&(e.columns({date:"",nextDate:"",payee:"",category:"",note:"",cleared:"",reconciled:"",amount:"",balance:""}),o.redraw()),P.getSessionDisplay()<=Ie.Medium&&e.columns({date:"",nextDate:"",payee:"",amount:"",balance:""})};let h;return{oninit:async()=>{q.spanStart("BudgetTransactions"),b(),o.route.param().page!==void 0&&(e.page=parseInt(o.route.param().page,10),a.offset=0,e.page!==1&&(a.offset=(e.page-1)*50)),o.route.param().recurring!==void 0&&(e.recurring=!0),o.route.param().month!==void 0&&(e.budgetCategoryMonth=o.route.param().month),o.route.param().import===void 0?a.data([]):e.importID(o.route.param().import),h=v.lift(async(t,n,C,F)=>{if(o.route.param().account!==void 0&&(e.budgetAccount(s.findID(o.route.param().account)),e.recurrenceCount=p.findBudgetAccountIDToday(e.budgetAccount().id)),o.route.param().category!==void 0&&(e.budgetCategory=T.findID(o.route.param().category)),o.route.param().payee!==void 0&&(e.budgetPayee=g.findID(o.route.param().payee)),F!==null&&(e.columns({date:"",payee:"",category:"",amount:""}),e.budgetAccount(s.findID(F)),o.redraw()),P.setLayoutApp({...Te("budget"),breadcrumbs:[{link:"/budget/accounts",name:r.translate(Q)},{link:`/budget/${u().toLowerCase()}`,name:`${u()}`},{name:m()}],toolbarActionButtons:[{icon:w.BudgetTransaction,name:r.translate(z),onclick:e.importID()!==null?async()=>{const x=[],M=[];for(const y of a.data())y.budgetPayeeName!==""&&(x.includes(y.budgetPayeeName)?(y.budgetPayeeID=g.findName(y.budgetPayeeName).id,y.budgetPayeeName=""):x.push(y.budgetPayeeName)),await a.create(y).catch(()=>{M.push(y)});if(M.length>0){a.data(M),o.redraw();return}return o.route.set(`/budget/transactions?account=${e.budgetAccount().id}`),e.importID(null),b(),a.read()}:()=>{P.setLayoutAppForm(R,{...p.new(),template:N()})},permitted:A.permitted(I.Budget,!0),requireOnline:!0}]}),a.data().length===0)return a.read();o.redraw()},s.data,T.data,g.data,e.importID),q.spanEnd("BudgetTransactions")},onremove:()=>{h.end(!0)},view:()=>[o(Ce,{buttons:[{name:`${r.translate(ee)} OFX/QFX`,oninput:async t=>{const n=new FileReader;n.onload=async()=>{typeof n.result=="string"&&(e.formImportVisible=!1,a.data(await Pe(n.result,e.budgetAccount().id)),o.route.set(`/budget/transactions?import=${e.budgetAccount().shortID}`,{},{state:{key:Date.now()}}))},n.readAsText(t)},permitted:!0,primary:!0,requireOnline:!0}],fields:e.formImportFields,oninput:(t,n)=>{e.formImportFields[t]=n},onsubmit:async t=>{a.data(await Se(t,e.budgetAccount().id,e.formImportFields)),o.route.set(`/budget/transactions?import=${e.budgetAccount().shortID}`,{},{state:{key:Date.now()}})},title:r.translate(G),toggle:t=>{e.formImportVisible=t},visible:e.formImportVisible}),o(ge,{actions:[{icon:w.ImportExport,name:r.translate(G),onclick:async()=>{if(e.importID()===null){e.formImportVisible=!0;return}const t=[];for(const n of a.data())await a.create(n).catch(()=>{t.push(n)});if(t.length>0){a.data(t),o.redraw();return}return o.route.set(`/budget/transactions?account=${e.budgetAccount().id}`),e.importID(null),b(),a.read()},permitted:A.permitted(I.Budget,!0),requireOnline:!0},{icon:w.Clear,name:r.translate(te),onclick:async()=>s.reconcile(e.budgetAccount().id).then(async()=>a.read()),permitted:A.permitted(I.Budget,!0)&&e.budgetAccount().id!==null&&s.findID(e.budgetAccount().id).budgetTransactionAmountCleared!==s.findID(e.budgetAccount().id).budgetTransactionAmountReconciled&&e.importID()===null,requireOnline:!0}],data:e.recurring?i():a.data(),editOnclick:t=>{t.template===void 0?P.setLayoutAppForm(R,{...p.new(),authHouseholdID:t.authHouseholdID,id:t.id,template:t}):P.setLayoutAppForm(R,t)},filters:[],id:"transactions",loaded:o.route.param().recurring!==void 0&&p.isLoaded()||a.loaded,noFilters:!0,tableColumns:e.recurring?[{name:r.translate(ae),property:"nextDate",render:ve,type:l.Date},{formatter:t=>{if(t.template.budgetPayeeID!==null)return g.findID(t.template.budgetPayeeID).name;if(t.template.accounts!==null&&t.template.accounts.length===2){for(const n of t.template.accounts)if(n.budgetAccountID!==e.budgetAccount().id)return`${n.amount>0?r.translate(_):r.translate(H)} ${s.findID(n.budgetAccountID).name}`}return r.translate($)},name:r.translate(W),property:"payee",type:l.Text},{formatter:t=>t.template.categories!==null?t.template.categories.length===1?T.findIDHeaderName(t.template.categories[0].budgetCategoryID):r.translate($):"",name:r.translate(L),property:"category",typeCheck:t=>t.template.categories!==null&&t.template.categories.length>1?l.Bold:l.Text},{currencyFormat:S.findID(e.budgetAccount().id===null?e.budgetCategory.id===null?e.budgetPayee.authHouseholdID:e.budgetCategory.authHouseholdID:e.budgetAccount().authHouseholdID).preferences.currency,formatter:t=>d(t.template),name:r.translate(V),property:"amount",type:l.Currency}]:[{name:r.translate(ne),property:"date",type:l.Date},{formatter:t=>{if(t.budgetPayeeName!=="")return t.budgetPayeeName;if(t.budgetPayeeID!==null)return g.findID(t.budgetPayeeID).name;if(t.accounts!==null){if(t.accounts.length===2){for(const n of t.accounts)if(n.budgetAccountID!==e.budgetAccount().id)return`${n.amount>0?r.translate(_):r.translate(H)} ${s.findID(n.budgetAccountID).name}`}else if(t.accounts.length===1)return r.translate(re)}return r.translate($)},name:r.translate(W),property:"payee",type:l.Text},{formatter:t=>t.categories===null||t.categories.length===0?"":t.categories.length===1?T.findIDHeaderName(t.categories[0].budgetCategoryID):r.translate($),name:r.translate(L),property:"category",typeCheck:t=>t.categories!==null&&t.categories.length>1?l.Bold:l.Text},{name:r.translate(oe),property:"note"},{currencyFormat:S.findID(e.budgetAccount().id===null?e.budgetCategory.id===null?e.budgetPayee.authHouseholdID:e.budgetCategory.authHouseholdID:e.budgetAccount().authHouseholdID).preferences.currency,formatter:t=>d(t),name:r.translate(V),property:"amount",type:l.Currency},{currencyFormat:S.findID(e.budgetAccount().id===null?e.budgetCategory.id===null?e.budgetPayee.authHouseholdID:e.budgetCategory.authHouseholdID:e.budgetAccount().authHouseholdID).preferences.currency,name:r.translate(ue),property:"balance",type:l.Currency},{checkboxOnclick:async t=>{if(e.cleared=t,e.cleared.accounts!==null){let n=!1;for(const C of e.cleared.accounts)if(C.budgetAccountID===e.budgetAccount().id){if(C.status===2)return;C.status>=1?C.status=0:C.status=1,await a.update(e.cleared).then(async()=>{n=!0})}n&&await a.read(!0)}},formatter:t=>{if(t.accounts!==null){for(const n of t.accounts)if(n.budgetAccountID===e.budgetAccount().id)return n.status>=1}return!1},name:r.translate(j),permitted:()=>A.permitted(I.Budget,!0),property:"cleared",type:l.Checkbox},{checkboxOnclick:async t=>{if(e.cleared=t,e.cleared.accounts!==null){for(const n of e.cleared.accounts)if(n.budgetAccountID===e.budgetAccount().id)return n.status===2?void 0:(n.status=2,a.update(e.cleared).then(async()=>a.read(!0)))}},formatter:t=>{if(t.accounts!==null){for(const n of t.accounts)if(n.budgetAccountID===e.budgetAccount().id)return n.status===2}return!1},name:r.translate(E),permitted:()=>A.permitted(I.Budget,!0),property:"reconciled",type:l.Checkbox}],tableColumnsNameEnabled:e.columns,title:{buttonLeft:e.page===1||e.recurring?void 0:{href:`${c()}&page=${e.page-1}`,icon:w.Previous,name:r.translate(ce),permitted:!0,requireOnline:!0},buttonRight:e.page*50>a.total||e.recurring?void 0:{href:`${c()}&page=${e.page+1}`,icon:w.Next,name:r.translate(ie),permitted:!0,requireOnline:!0},loaded:o.route.param().recurring!==void 0&&p.isLoaded()||a.loaded,name:e.importID()!==null||e.recurring?void 0:f(),subtitles:e.importID()!==null||e.recurring||e.budgetAccount().id===null?void 0:[{color:s.findID(e.budgetAccount().id).budgetTransactionAmount<0?"var(--color_negative)":"var(--color_positive)",key:`${r.translate(de)}:`,value:O.toString(e.budgetAccount().budgetTransactionAmount,S.findID(e.budgetAccount().authHouseholdID).preferences.currency)},{color:s.findID(e.budgetAccount().id).budgetTransactionAmountCleared<0?"var(--color_negative)":"var(--color_positive)",key:`${r.translate(j)}:`,value:O.toString(e.budgetAccount().budgetTransactionAmountCleared,S.findID(e.budgetAccount().authHouseholdID).preferences.currency)},{color:s.findID(e.budgetAccount().id).budgetTransactionAmountReconciled<0?"var(--color_negative)":"var(--color_positive)",key:`${r.translate(E)}:`,value:O.toString(e.budgetAccount().budgetTransactionAmountReconciled,S.findID(e.budgetAccount().authHouseholdID).preferences.currency)}],tabs:e.budgetAccount().id===null||e.importID()!==null?void 0:[{active:!e.recurring,href:o.parsePathname(o.route.get()).path,name:r.translate(se)},{active:e.recurring,count:e.recurrenceCount,href:`${o.route.get()}${o.route.get().includes("?")?"&":"?"}recurring`,name:r.translate(le)}]}})]}}export{Oe as BudgetTransactions};
