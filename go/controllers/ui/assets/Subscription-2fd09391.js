import{m as u,V as h,C as c,A as l,c as a,i7 as E,i8 as U,dt as d,_ as H,a8 as f,D as s,S as m,i9 as y,ia as B,h8 as n,h2 as k,ib as K,ah as w,ai as v,k as b,ic as C,F as A,id as I,ie as W,c6 as T,ig as $,c5 as L,hT as g,hU as G,ih as F,b as x,Z as P,y as O,ii as j,I as S,ij as N,a as V,b2 as D}from"./index-09c2e996.js";import{F as q}from"./FormSubscription-0bb20cc1.js";import{G as R}from"./GetHelp-610c77dd.js";import"./Payment-7ef1bf2a.js";import"./TitleTabsAuthHouseholds-59423851.js";function J(){return{view:e=>u("div.IconRow",[e.attrs.icons.map(t=>t.visible===!1?[]:u("div",{id:t.id,onclick:r=>{r.stopPropagation(),t.onclick()}},u("i.GlobalButtonIcon",t.icon)))])}}const p={create:async e=>h.create(`/api/v1/cloud/${e}/backups`).then(t=>{if(c(t))return l.setLayoutAppAlert(t),t;l.setLayoutAppAlert({message:a.translate(E)})}),delete:async(e,t)=>h.delete(`/api/v1/cloud/${e}/backups/${t}`).then(r=>{if(c(r))return l.setLayoutAppAlert(r),r;l.setLayoutAppAlert({message:a.translate(U)})}),inResponse(e){return e.dataType==="CloudBackups"},is(e){return e!==null},new:()=>({created:null,id:null}),readAll:async e=>d.data().cloud?new Promise(t=>t([])):h.read(`/api/v1/cloud/${e}/backups`,{}).then(t=>c(t)?(l.setLayoutAppAlert(t),t):p.inResponse(t)?t.dataValue:(l.setLayoutAppAlert(H),H)),restore:async(e,t)=>h.read(`/api/v1/cloud/${e}/backups/${t}`,{}).then(r=>{if(c(r))return l.setLayoutAppAlert(r),r})};function X(){const e={authHousehold:f(s.findID(a.data().primaryAuthHouseholdID)),backups:m([]),columns:m({actions:"",created:""}),loaded:!1,showBackups:!1,showEncryptionKey:!1,showURL:!1,url:""};async function t(o){return p.readAll(o).then(async i=>{c(i)||(e.backups(i),e.loaded=!0,u.redraw())})}let r;return{oninit:async()=>{e.loaded=!1,D.spanStart("Subscription"),r=s.data.map(async o=>{e.authHousehold.id===null&&(e.authHousehold=f(s.findID(a.data().primaryAuthHouseholdID)),e.authHousehold.id===null&&(e.authHousehold=f(s.findID(u.route.param().household))),e.authHousehold.id!==null&&u.route.param().success!==void 0&&(y.purchase(),B.purchase(e.authHousehold.subscriptionProcessor),setTimeout(async()=>{await n.readJWT(e.authHousehold.id)},1e3)));for(const i of o)e.authHousehold.id===i.id&&i.backupEncryptionKey!==""&&(l.setLayoutApp({...R(),breadcrumbs:[{name:a.translate(k)}],toolbarActionButtons:[{name:a.translate(K),onclick:async()=>p.create(i.id).then(async()=>t(i.id)),permitted:w.permitted(v.Auth,!0,i.id)&&!d.data().cloud&&i.backupEncryptionKey!=="",requireOnline:!0}]}),e.backups().length===0&&await t(e.authHousehold.id))}),l.setLayoutApp({...R(),breadcrumbs:[{name:a.translate(k)}],toolbarActionButtons:[]}),d.data().cloud?e.url=s.findID(e.authHousehold.id).selfHostedURL:e.url=n.findID(e.authHousehold.id).selfHostedURL,!d.data().cloud&&s.findID(e.authHousehold.id).backupEncryptionKey!==""&&await t(e.authHousehold.id),D.spanEnd("Subscription")},onremove:()=>{r.end(!0)},view:()=>[u(q,{authHouseholdID:e.authHousehold.id}),u(x,{title:{name:a.translate(F)}},[d.data().cloud?[]:[u(b,{name:a.translate(C),onclick:async()=>{if(s.findID(e.authHousehold.id).backupEncryptionKey!=="")return e.authHousehold.backupEncryptionKey="",s.update(e.authHousehold).then(()=>{e.showBackups=!1});if(n.isExpired()){y.subscriptionNeeded();return}e.showBackups=!e.showBackups},value:e.showBackups||s.findID(e.authHousehold.id).backupEncryptionKey!==""}),e.showBackups||s.findID(e.authHousehold.id).backupEncryptionKey!==""?[u(A,{input:{oninput:o=>{e.authHousehold.backupEncryptionKey=o,setTimeout(async()=>{if(e.authHousehold.backupEncryptionKey===o&&s.findID(e.authHousehold.id).backupEncryptionKey!==o)return s.update(e.authHousehold)},500)},type:e.showEncryptionKey?"text":"password",value:e.authHousehold.backupEncryptionKey},name:a.translate(I),tooltip:a.translate(W)}),u(b,{name:`${a.translate(T)} ${a.translate(I)}`,onclick:()=>{e.showEncryptionKey=!e.showEncryptionKey},value:e.showEncryptionKey})]:[]],u(b,{name:a.translate($),onclick:async()=>{if(d.data().cloud)e.authHousehold.selfHostedURL===""?e.showURL=!e.showURL:(e.authHousehold.selfHostedURL="",await s.update(e.authHousehold),e.showURL=e.authHousehold.selfHostedURL!=="");else if(n.isExpired()){y.subscriptionNeeded();return}else if(!d.data().cloud)return n.update({...n.findID(e.authHousehold.id),selfHostedURL:n.findID(e.authHousehold.id).selfHostedURL===""?`${L().hostname===""?window.location.origin:L().hostname}`:""}).then(()=>{e.url=n.findID(e.authHousehold.id).selfHostedURL,e.showURL=n.findID(e.authHousehold.id).selfHostedURL!=="",u.redraw()})},value:e.showURL||n.findID(e.authHousehold.id).selfHostedURL!==""||s.findID(e.authHousehold.id).selfHostedURL!==""}),e.showURL===!0||s.findID(e.authHousehold.id).selfHostedURL!==""||n.findID(e.authHousehold.id).selfHostedURL!==""?u(A,{input:{oninput:o=>{e.url=o,setTimeout(async()=>{if(e.url===o)return d.data().cloud?s.update({...s.findID(e.authHousehold.id),selfHostedURL:o}):n.update({...n.findID(e.authHousehold.id),selfHostedURL:o})},500)},type:"text",value:e.url},name:a.translate(g),tooltip:a.translate(G)}):[]]),!d.data().cloud&&e.authHousehold.backupEncryptionKey!==""?u(V,{actions:[],data:e.backups(),filters:[],loaded:e.loaded,noFilters:!0,tableColumns:[{formatter:o=>P.fromString(o.created).toPrettyString(a.data().preferences.formatDateOrder,a.data().preferences.formatDateSeparator,a.data().preferences.formatTime24),name:a.translate(O),property:"created"},{name:a.translate(j),property:"actions",render:()=>({view:o=>u(J,{icons:[{icon:S.Backup,onclick:async()=>p.restore(e.authHousehold.id,o.attrs.id).then(async()=>w.signOut())},{icon:S.Delete,onclick:async()=>p.delete(e.authHousehold.id,o.attrs.id).then(async()=>t(e.authHousehold.id))}]})})}],tableColumnsNameEnabled:e.columns,title:{name:a.translate(N)}}):[]]}}export{X as Subscription};
