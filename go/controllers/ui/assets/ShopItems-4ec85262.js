import{S as s,eP as g,dk as d,ax as I,c as a,ds as b,hz as R,dj as n,eO as L,A as p,ab as N,ed as O,eE as j,m as r,a0 as T,aC as q,I as $,hA as J,hB as z,aZ as x,az as _,hC as K,hD as U,ah as h,ai as D,d9 as V,hE as X,hF as Y,a$ as Z,bF as G,dM as Q,hG as ee,T as m,hH as te,hI as W,af as ae,D as C,hJ as re,aN as oe,dl as ne,ct as se,bB as S,d2 as ie,cn as le,hK as ue,eN as ce,b9 as pe,ay as M,hL as me,ak as de,hM as Ie,a as he,aY as De,a_ as fe,a8 as ye,b2 as w,eV as y}from"./index-09c2e996.js";import{F as ge}from"./Filter-01c23926.js";import{T as be}from"./TableColumnHousehold-f6fe7c15.js";import{G as Ce}from"./GetHelp-610c77dd.js";function Se(){return{view:e=>r("div.TableData__buttons",[r("span",e.attrs.name),e.attrs.recurrence===null?[]:r(De,{accent:!0,id:`skip-${e.attrs.id}`,name:a.translate(fe),onclick:async()=>{const i=ye(e.attrs);return i.nextDate=x.nextCivilDate(i.recurrence,_.fromString(`${i.nextDate}`)).toJSON(),n.update(i)},permitted:h.permitted(D.Shop,!0),requireOnline:!0})])}}function Oe(){const e={amount:0,categories:[],categoryID:s(null),columns:s({}),countAll:0,countInCart:0,countToGet:0,list:s(g.new()),listID:s(null),positions:[],search:s(""),sort:s({formatter:l=>d.findID(l.shopCategoryID).name,invert:!1,property:"shopCategoryID"}),status:s(""),store:s(I.new()),storeID:s(null)};let i;return{oninit:async()=>{w.spanStart("ShopItems"),i=s.lift((l,t,c,ke,k,H,P,E,A,v,F)=>{let u=[],f=[];v!==null?(e.list(g.findID(v)),f=[{link:"/shop/items",name:a.translate(b)},{link:"/shop/lists",name:a.translate(R)},{name:e.list().name}],u=n.data().filter(o=>o.shopListID===e.list().id)):F!==null?(e.store(I.findID(F)),f=[{link:"/shop/items",name:a.translate(b)},{link:"/shop/items",name:a.translate(L)},{name:e.store().name}],u=n.getPickupItems().filter(o=>o.budgetPayeeID===e.store().id||o.budgetPayeeID===null)):(f=[{link:"/shop/items",name:a.translate(b)},{name:a.translate(L)}],u=n.getPickupItems()),p.setLayoutApp({...Ce("shop"),breadcrumbs:f,toolbarActionButtons:[{...N().newShopItem,onclick:()=>{p.setLayoutAppForm(O,{...n.new(),authAccountID:e.list().authAccountID,authHouseholdID:e.list().authHouseholdID,budgetPayeeID:e.storeID(),shopListID:e.listID()})}}]}),e.categories=[],e.countAll=u.length,e.countInCart=0,e.countToGet=0,u=u.filter(o=>k!==null&&o.shopCategoryID!==k||(o.inCart?e.countInCart++:e.countToGet++,P!==""&&!o.name.toLowerCase().includes(P.toLowerCase()))||A==="toget"&&o.inCart||A==="incart"&&o.inCart===!1?!1:(o.shopCategoryID!==null&&e.categories.findIndex(B=>B.id===o.shopCategoryID)<0&&e.categories.push({id:o.shopCategoryID,name:d.findID(o.shopCategoryID).name}),!0)),e.amount=0;for(const o of u)o.inCart||(e.amount+=o.price);return e.positions=j.sort(u).map(o=>o.id),r.redraw(),ge.array(u,H,E)},I.data,d.data,g.data,n.data,e.categoryID,e.columns,e.search,e.sort,e.status,e.listID,e.storeID),r.route.param().category===void 0?e.categoryID(null):e.categoryID(r.route.param().category),r.route.param().filter===void 0?e.status(""):e.status(r.route.param().filter),r.route.param().list===void 0?e.listID(null):e.listID(r.route.param().list),r.route.param().store===void 0?e.storeID(null):e.storeID(r.route.param().store),e.columns=s({inCart:"",name:"",shopCategoryID:""}),e.listID()!==null&&e.columns({position:"",...e.columns()}),p.getSessionDisplay()>T.XSmall&&(e.columns().budgetPayeeID="",e.columns().price=""),p.getSessionDisplay()>T.Small&&(e.columns().cookRecipeID="",e.columns().cookMealPlanID="",e.columns().planProjectID=""),w.spanEnd("ShopItems")},view:()=>{const l=q.findID(e.list().budgetCategoryID);return r(he,{actions:[{accent:!0,icon:$.Clear,name:e.listID()===null?a.translate(J):a.translate(z),onclick:async()=>{for(const t of i().filter(c=>c.inCart))t.inCart===!0&&(t.recurrence!==null&&t.nextDate!==null?(t.nextDate=x.nextCivilDate(t.recurrence,_.fromString(t.nextDate)).toJSON(),t.inCart=!1,await n.update(t,!0)):await n.delete(t.id,!0));p.setLayoutAppAlert({message:e.listID()===null?a.translate(K):a.translate(U)})},permitted:h.permitted(D.Shop,!0)&&i().filter(t=>t.inCart).length>0&&e.status()!=="toget",requireOnline:!0},...e.listID()===null?[]:[{icon:$.Edit,name:`${a.translate(V)} ${a.translate(X)}`,onclick:async()=>new Promise(t=>(p.setLayoutAppForm(Y,e.list()),t())),permitted:h.permitted(D.Shop,!0,e.list().authHouseholdID),requireOnline:!0}]],data:i(),editOnclick:t=>{p.setLayoutAppForm(O,t)},filters:[{name:a.translate(Z),onclick:t=>{e.categoryID()===t?e.categoryID(null):e.categoryID(t)},selected:()=>[`${e.categoryID()}`],value:e.categories}],loaded:I.isLoaded()&&G.isLoaded()&&d.isLoaded()&&n.isLoaded(),search:{onsearch:t=>{e.search(t)},placeholder:a.translate(Q)},sort:e.sort,tableColumns:[{formatter:t=>e.positions.indexOf(t.id)+1,name:a.translate(ee),ondragend:async()=>{if(y.state.target!==""){const t=n.findID(y.state.source.split("_")[1]),c=n.findID(y.state.target.split("_")[1]);return t.position=j.adjacent(c,n.findAdjacent(c),y.state.before),n.update(t)}},permitted:t=>h.permitted(D.Shop,!0,t.authHouseholdID),property:"position",type:m.Drag},{checkboxOnclick:async t=>(t.inCart=!t.inCart,n.update(t).catch(()=>{t.inCart=!t.inCart})),name:r.route.get().includes("list")?a.translate(te):a.translate(W),noFilter:!0,permitted:t=>h.permitted(D.Shop,!0,t.authHouseholdID),property:"inCart",type:m.Checkbox},{name:a.translate(ae),noFilter:!0,property:"name",render:Se},{currencyFormat:C.findID(a.data().primaryAuthHouseholdID).preferences.currency,formatter:t=>t.price===void 0||t.price===0?"":-1*t.price,name:a.translate(re),noFilter:!0,property:"price",type:m.Currency},{formatter:t=>d.findID(t.shopCategoryID).name,linkFormatter:t=>r.buildPathname("/shop/items",{...r.route.param(),category:t.shopCategoryID}),name:a.translate(oe),noFilter:!0,property:"shopCategoryID",type:m.Link},{formatter:t=>I.findID(t.budgetPayeeID).name,linkFormatter:t=>r.buildPathname("/shop/items",{...r.route.param(),store:t.budgetPayeeID}),name:a.translate(ne),noFilter:!0,property:"budgetPayeeID",type:m.Link},{formatter:t=>se.findID(S.findID(t.cookMealPlanID).cookRecipeID).name,linkFormatter:t=>`/cook/recipes/${S.findID(t.cookMealPlanID).cookRecipeID}`,name:a.translate(ie),noFilter:!0,property:"cookRecipeID",type:m.Link},{formatter:t=>{if(t.cookMealPlanID===null)return"";const c=S.findID(t.cookMealPlanID);return`${p.formatCivilDate(c.date)} - ${le.findID(c.cookMealTimeID).name}`},linkFormatter:()=>"/calendar",name:a.translate(ue),noFilter:!0,property:"cookMealPlanID",type:m.Link},{formatter:t=>G.findID(t.planProjectID).name,linkFormatter:t=>`/plan/tasks?project=${t.planProjectID}`,name:a.translate(ce),noFilter:!0,property:"planProjectID",type:m.Link},be()],tableColumnsNameEnabled:e.columns,title:{subtitles:[...e.list().budgetCategoryID===null?[]:[{color:l.budgetMonthCategoryAmount+l.budgetTransactionAmount>0?"var(--color_positive)":"var(--color_negative)",key:a.translate(pe),value:M.toString(l.budgetMonthCategoryAmount+l.budgetTransactionAmount,C.findID(a.data().primaryAuthHouseholdID).preferences.currency)}],...e.amount>0?[{color:l.budgetMonthCategoryAmount+l.budgetTransactionAmount>=e.amount?"var(--color_positive)":"var(--color_negative)",key:a.translate(me),value:M.toString(e.amount,C.findID(a.data().primaryAuthHouseholdID).preferences.currency)}]:[]],tabs:r.route.get().includes("list")?void 0:[{active:r.route.param().filter===void 0,count:e.countAll,href:`/shop/items${r.route.param().store===void 0?"":`?store=${r.route.param().store}`}`,name:a.translate(de)},{active:r.route.param().filter==="incart",count:e.countInCart,href:`${r.parsePathname(r.route.get()).path}?filter=incart${r.route.param().store===void 0?"":`&store=${r.route.param().store}`}`,name:a.translate(W)},{active:r.route.param().filter==="toget",count:e.countToGet,href:`/shop/items?filter=toget${r.route.param().store===void 0?"":`&store=${r.route.param().store}`}`,name:a.translate(Ie)}]}})}}}export{Oe as ShopItems};
